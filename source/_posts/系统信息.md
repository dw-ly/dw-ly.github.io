---
title: 系统信息分析
category:
 - 学习笔记
tag:
 - linux
description: 系统信息分析

---
#### 案例分析

登录到服务器，查看当前系统负载 。当前系统负载高有cpu使用率高、io使用率高、以及两者都高三种情况。  
cpu 使用率高，可能确实是使用率高， 也的可能实际处理不高而是进程太多切换上下文频繁 ， 也可能是进程内线程的上下文切换频繁。
io 使用率高 ， 说明 io 请求比较大， 可能是 文件io 、 网络io 。   

查看系统负载：uptime（ watch -d uptime）看三个阶段平均负载

##### 一.平均负载

单位时间内系统处于**可运行状态**和**不可中断状态**的平均进程数即平均活跃进程数，和CPU使用率没有直接关系。其中**可运行状态**指的是正在使用CPU或者正在等待CPU的进程，也就是ps命令中处于R状态（Running或Runnable）的进程。**不可中断状态**是处于内核态关键流程中的进程，如IO等，也就是D状态（Uninterruptible Sleep，也称为 Disk Sleep）的进程。不可中断状态是系统对进程和硬件设备的一种保护机制。

**平均负载**不仅包含了正在使用CPU的进程，还包括等待CPU和等待IO的进程。而**CPU使用率**是单位时间内CPU繁忙情况的统计，跟平均负载并不完全对应。

如：

> - CPU密集型进程，使用大量CPU，导致平均负载升高，此时二者一致。
> - IO密集型进程，等待IO会导致平均负载升高，但是此时CPU使用率不一定高。
> - 大量等待CPU的进程调度会导致平均负载升高，此时CPU使用率也会比较高。

##### 1.uptime

uptime：[uptime 命令介绍](https://blog.csdn.net/u014389734/article/details/79392440)

##### 2.mpstat

```shell
mpstat -P ALL 3
```

通过`mpstat -P ALL 3`查看每个cpu当前的状况，所有cpu的平均指标，可以重点看用户态、内核态、以及io等待(iowait)三个参数 

简单理解字段含义：

- user:用户态
- sys：系统CPU使用率
- iowait：io等待
- irq：硬中断
- soft：软中断
- idle：闲置时间（除去等待IO操作）

参考：[mpstat使用详解](https://blog.csdn.net/sinat_32321377/article/details/53281897)

##### 二.上下文切换

按照场景可以区分为进程上下文切换、线程上下文切换和中断上下文切换。过多的上下文切换会把CPU时间消耗在寄存器、内核栈及虚拟内存等数据的保存和恢复上。按照产生原因可以分为**自愿上下文切换**和**非自愿上下文切换**。
**自愿上下文切换**是进程无法获取所需资源导致的上下文切换。如I\O、内存等系统资源不足时产生的。**非自愿上下文切换**是进程时间片已到等原因导致被系统强制调度。比如大量进程在争抢cpu使用时。

##### 3.pidstat

```shell
pidstat -u ## pidstat -w(进程切换指标)/-u（cpu使用指标）/-wt(线程上下文切换指标)
```

查看详细的上下文切换情况 ： pidstat （pidstat -w(进程切换指标)/-u（cpu使用指标）/-wt(线程上下文切换指标)） 注意看是自愿上下文切换、还是被动上下文切换 

> pidstat 中， %wait 表示进程等待 CPU 的时间百分比。此时进程是运行状态。 
> top 中 ，iowait% 则表示等待 I/O 的 CPU 时间百分比。此时进程处于不可中断睡眠态。 
> 等待 CPU 的进程已经在 CPU 的就绪队列中，处于运行状态；而等待 I/O 的进程则处于不可中断状态。

##### 4.vmstat

系统整体的平均上下文切换情况 ：`vmstat 3`
可以重点关注如下指标  

> - cs（context switch）是每秒上下文切换的次数。
> - in（interrupt）则是每秒中断的次数。
> - r（Running or Runnable）是就绪队列的长度，也就是正在运行和等待 CPU 的进程数。（远超cpu个数时会产生大量cpu竞争）
> - b（Blocked）则是处于不可中断睡眠状态的进程数。 

**问题：vmstat 貌似只打印一次的情况下in(每秒中断数，包括时钟中断) 、cs(每秒上下文切换数)不会显示正确值。**

**解答：vmstat第一行是系统启动以来的平均值，见man手册**

> The  first  report produced gives averages since the last reboot.  Additional reports give information on a sampling period of length delay.  The process and memory reports are instantaneous in either case.

**另外vmstat可以看进程内存信息(读写、缓存、使用情况等)**

[Linux之vmstat命令](https://baijiahao.baidu.com/s?id=1706815541297876574&wfr=spider&for=pc)

暂时只整理了一部分。。。
